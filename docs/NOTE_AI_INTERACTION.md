# 笔记-AI 交互功能文档

## 功能概述

本次更新实现了笔记编辑器与 AI 助手之间的深度交互，支持 4 种笔记类型（Markdown、富文本、思维导图、流程图）与 AI 的双向通信。

## 核心功能

### 1. 笔记内容发送到 AI

#### 支持的笔记类型
| 类型 | 发送格式 | 说明 |
|------|---------|------|
| Markdown | 原始 Markdown 文本 | 直接发送，AI 理解 Markdown 语法 |
| Rich Text | HTML 内容 | 发送富文本的 HTML 表示 |
| Mind Map | JSON 结构 | 发送思维导图的完整 JSON 数据 |
| Drawio | XML 数据 | 发送流程图的 mxGraph XML |

#### 使用方式
- 点击 AI 面板中的"发送笔记内容"按钮
- 点击"发送选中内容"按钮（需先在编辑器中选择文本）

### 2. AI 回复导入到编辑器

#### 导入模式
- **追加到末尾**: 将 AI 回复添加到笔记末尾
- **插入到光标**: 在当前光标位置插入内容
- **替换全部**: 用 AI 回复替换整个笔记内容
- **应用到选中区域**: 仅替换选中的部分（需先选中内容）

#### 智能格式转换
系统会根据目标笔记类型自动转换 AI 回复：
- **Markdown**: 自动移除代码块包装（```markdown）
- **Rich Text**: 基本 Markdown 到 HTML 转换（标题、加粗、斜体、列表）
- **Mind Map**: 
  - 解析 JSON 数组为子节点
  - 从代码块提取 JSON
  - 从普通文本生成节点结构
- **Drawio**: 从代码块提取 XML

### 3. 编辑器历史功能

#### 撤销/重做
- **快捷键**: `Ctrl+Z`（撤销）、`Ctrl+Y` 或 `Ctrl+Shift+Z`（重做）
- **工具栏按钮**: 编辑器头部的撤销/重做图标
- **历史计数**: 显示 `当前位置/总数`

#### 自动保存历史
- 每 5 秒自动保存一个历史点
- AI 导入内容自动创建历史点
- 最多保存 50 条历史记录

### 4. 笔记类型专用快捷操作

#### Markdown
- 续写内容
- 生成目录
- 格式化代码
- 添加注释

#### Rich Text
- 美化格式
- 转 Markdown
- 生成要点

#### Mind Map
- 扩展节点
- 优化结构
- 生成摘要
- 补充分支
- 重新组织

#### Drawio
- 分析流程
- 优化流程
- 生成说明
- 检查完整性

### 5. 快速提问功能

选中内容后，可以一键执行：
- **解释**: 请 AI 解释选中内容
- **翻译**: 请 AI 翻译选中内容
- **改写**: 请 AI 改写使内容更专业
- **总结**: 请 AI 总结要点
- **扩展**: 请 AI 扩展添加更多细节

### 6. AI 响应历史

#### 功能特点
- 自动保存最近 10 条 AI 响应
- 可折叠的历史面板
- 显示响应时间和导入状态

#### 每条历史可执行操作
- **导入**: 重新打开导入预览，将历史响应导入编辑器
- **复制**: 复制响应内容到剪贴板
- **删除**: 删除单条历史记录
- **清空**: 一键清空所有历史

#### 视觉反馈
- 紫色边框：未导入的响应
- 绿色边框：已导入的响应
- 时间戳显示
- "已导入"标签

### 7. 笔记类型快速切换

#### 使用方式
- 点击编辑器标题栏左侧的笔记类型图标
- 从下拉菜单中选择目标类型
- 支持在 4 种类型间快速切换

#### 类型选项
- **Markdown**: 蓝色图标，适合写作和代码
- **富文本**: 绿色图标，所见即所得编辑
- **思维导图**: 紫色图标，可视化思维结构
- **流程图**: 橙色图标，流程和图表绘制

## UI 增强

### 编辑器工具栏
- 撤销/重做按钮
- 历史计数指示器
- 选中状态指示器（显示选中字符数）

### 底部状态栏
- 字符数统计
- 行数统计
- 预计阅读时间
- 笔记类型标识
- AI 启用状态
- 快捷键提示

### AI 面板增强
- 笔记统计信息（字符数、行数、类型特定统计）
- 选中内容预览卡片
- 导入预览模态框（可编辑）
- 导入成功 Toast 提示

## 快捷键汇总

| 快捷键 | 功能 |
|--------|------|
| `Ctrl+Z` | 撤销 |
| `Ctrl+Y` / `Ctrl+Shift+Z` | 重做 |
| `Ctrl+Shift+A` | 打开/关闭 AI 面板 |

## 技术实现

### 状态管理
使用 Zustand 创建 `noteAIStore` 管理：
- 历史记录栈（最多 50 条）
- 当前选中内容
- 笔记类型和内容
- 编辑器引用

### 编辑器集成
使用 React `forwardRef` 和 `useImperativeHandle` 暴露编辑器方法：
- `getSelection()`: 获取选中内容
- `getContent()`: 获取完整内容
- `insertContent(content, position)`: 插入内容
- `replaceContent(content)`: 替换内容

### 文件结构
```
store/
  noteAIStore.ts          # 笔记-AI 交互状态管理

components/
  Editor.tsx              # 编辑器主组件（撤销/重做、状态栏）
  AIPanel.tsx             # AI 面板（发送、导入、快捷操作）
  editors/
    MarkdownEditor.tsx    # Markdown 编辑器（选择追踪）
    RichTextEditor.tsx    # 富文本编辑器（选择追踪）
    MindMapEditor.tsx     # 思维导图编辑器（节点选择）
    DrawioEditor.tsx      # 流程图编辑器（XML 追踪）
```

## 开发服务器

```bash
# 启动开发服务器
bash start.sh

# 访问地址
# 前端: http://localhost:3212
# 后端: http://localhost:3215
```
