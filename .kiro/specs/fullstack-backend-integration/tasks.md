# 全栈后端集成实施计划

## 概述

将现有的AI Ignite Note前端应用转换为完整的全栈应用，添加Node.js后端、PostgreSQL数据库、IndexedDB缓存和Docker容器化支持。

## 任务

- [x] 1. 后端项目初始化和基础架构
  - 创建backend目录结构
  - 初始化Node.js + Express项目
  - 配置TypeScript和基础依赖
  - 设置开发环境和脚本
  - _需求: 1.1, 1.4_

- [x] 2. 数据库集成和Prisma配置
  - [x] 2.1 设置PostgreSQL数据库连接
    - 安装和配置Prisma ORM
    - 创建数据库连接配置
    - _需求: 1.2, 1.3_

  - [x] 2.2 转换SQL架构为Prisma Schema
    - 将ai-ignite-note.sql转换为schema.prisma
    - 配置数据库关系和索引
    - _需求: 11.1_

  - [ ]* 2.3 编写数据库连接属性测试
    - **属性 3: 笔记数据持久化一致性**
    - **验证需求: 3.1, 3.3**

  - [ ] 2.4 执行数据库迁移和初始化
    - 运行Prisma迁移创建表结构
    - 验证所有表和索引正确创建
    - _需求: 11.1_

- [x] 3. 用户认证系统实现
  - [x] 3.1 实现JWT认证中间件
    - 创建JWT token生成和验证逻辑
    - 实现认证中间件
    - _需求: 2.1, 2.2, 2.3_

  - [x] 3.2 实现用户注册和登录API
    - POST /api/auth/register 端点
    - POST /api/auth/login 端点
    - 密码加密和验证
    - _需求: 2.1, 2.2_

  - [ ]* 3.3 编写用户认证属性测试
    - **属性 2: 用户认证令牌有效性**
    - **验证需求: 2.1, 2.2, 2.3**

  - [x] 3.4 实现token刷新和登出功能
    - POST /api/auth/refresh 端点
    - POST /api/auth/logout 端点
    - _需求: 2.4, 2.5_

- [x] 4. 核心笔记管理API开发
  - [x] 4.1 实现笔记CRUD操作
    - GET /api/notes (列表查询，支持分页)
    - POST /api/notes (创建笔记)
    - GET /api/notes/:id (获取单个笔记)
    - PUT /api/notes/:id (更新笔记)
    - DELETE /api/notes/:id (软删除)
    - _需求: 3.1, 3.2, 3.3, 3.4_

  - [ ]* 4.2 编写笔记管理属性测试
    - **属性 3: 笔记数据持久化一致性**
    - **属性 4: 软删除数据完整性**
    - **验证需求: 3.1, 3.3, 3.4**

  - [ ] 4.3 实现笔记版本控制
    - 创建笔记版本历史记录
    - GET /api/notes/:id/versions 端点
    - _需求: 3.3_

- [ ] 5. 文件夹和标签管理系统
  - [ ] 5.1 实现文件夹管理API
    - GET /api/folders (获取文件夹树)
    - POST /api/folders (创建文件夹)
    - PUT /api/folders/:id (更新文件夹)
    - DELETE /api/folders/:id (删除文件夹)
    - _需求: 4.1, 4.2, 4.5_

  - [ ] 5.2 实现标签管理API
    - GET /api/tags (获取标签列表)
    - POST /api/tags (创建标签)
    - PUT /api/tags/:id (更新标签)
    - DELETE /api/tags/:id (删除标签)
    - _需求: 4.3, 4.4_

  - [ ]* 5.3 编写文件夹和标签属性测试
    - **属性 6: 文件夹层级关系完整性**
    - **属性 7: 标签关联双向一致性**
    - **验证需求: 4.1, 4.3, 4.4, 4.5**

- [x] 6. 全文搜索功能实现
  - [x] 6.1 实现PostgreSQL全文搜索
    - 配置tsvector搜索索引
    - 实现搜索查询逻辑
    - GET /api/search 端点
    - _需求: 3.5, 9.1, 9.2, 9.3_

  - [ ]* 6.2 编写搜索功能属性测试
    - **属性 5: 全文搜索结果相关性**
    - **属性 13: 搜索结果排序一致性**
    - **验证需求: 3.5, 9.1, 9.2, 9.5**

  - [x] 6.3 实现高级搜索和筛选
    - 按文件夹、日期范围筛选
    - 搜索结果排序和分页
    - _需求: 9.4, 9.5_

- [x] 7. 多模型AI功能集成和代理服务
  - [x] 7.1 实现AI提供商适配器架构
    - 创建AIProvider接口和基类
    - 实现AIProviderFactory工厂模式
    - 统一AI响应格式
    - _需求: 5.1, 5.2_

  - [x] 7.2 实现各AI提供商适配器
    - 实现GeminiProvider（Google Gemini）
    - 实现AnthropicProvider（Claude）
    - 实现OpenAIProvider（GPT系列）
    - 实现OllamaProvider（本地部署）
    - 实现LMStudioProvider（本地部署）
    - _需求: 5.1, 5.7_

  - [x] 7.3 实现AI对话API端点
    - POST /api/ai/chat 端点（支持多提供商）
    - GET /api/ai/providers 端点（获取可用提供商）
    - AI请求路由和响应处理
    - _需求: 5.1, 5.2_

  - [ ]* 7.4 编写AI多提供商属性测试
    - **属性 8: AI多提供商响应完整性**
    - **验证需求: 5.1, 5.5**

  - [x] 7.5 实现AI对话历史管理
    - GET /api/ai/conversations 端点
    - 对话历史存储（包含提供商和模型信息）
    - _需求: 5.3_

  - [ ] 7.6 实现AI模板管理
    - GET /api/ai/templates 端点
    - POST /api/ai/templates 端点
    - 模板兼容性处理（适配不同提供商）
    - _需求: 5.4_

  - [ ] 7.7 实现AI配额管理
    - 每个提供商的使用量监控
    - API调用限流和配额控制
    - _需求: 5.6_

- [x] 8. 文件上传和附件管理
  - [x] 8.1 实现文件上传服务
    - 配置Multer文件上传中间件
    - POST /api/attachments 端点
    - 文件存储和URL生成
    - _需求: 6.1, 6.2_

  - [x] 8.2 实现附件权限控制
    - GET /api/attachments/:id 端点
    - 用户权限验证
    - DELETE /api/attachments/:id 端点
    - _需求: 6.3, 6.4_

  - [ ]* 8.3 编写文件管理属性测试
    - **属性 9: 文件上传存储一致性**
    - **属性 10: 用户权限访问控制**
    - **验证需求: 6.1, 6.2, 6.4**

  - [x] 8.4 实现文件大小限制和验证
    - 文件类型和大小验证
    - 错误处理和响应
    - _需求: 6.5_

- [x] 9. 工作空间和协作功能
  - [x] 9.1 实现工作空间管理API
    - GET /api/workspaces 端点
    - POST /api/workspaces 端点
    - 工作空间权限管理
    - _需求: 7.1, 7.3_

  - [x] 9.2 实现成员邀请和管理
    - POST /api/workspaces/:id/members 端点
    - 邮件邀请功能
    - _需求: 7.2_

  - [ ]* 9.3 编写协作功能属性测试
    - **属性 10: 用户权限访问控制**
    - **验证需求: 7.3**

  - [x] 9.4 实现笔记共享和协作
    - 工作空间内笔记共享
    - 协作权限控制
    - _需求: 7.4_

- [x] 10. 前端API客户端开发
  - [x] 10.1 创建API客户端封装
    - 创建services/api.ts
    - 实现HTTP请求封装
    - 添加认证token管理
    - _需求: 8.1_

  - [x] 10.2 实现IndexedDB缓存层
    - 创建services/indexedDB.ts
    - 实现数据缓存和同步逻辑
    - _需求: 8.3, 8.4_

  - [ ]* 10.3 编写前端集成属性测试
    - **属性 11: IndexedDB缓存数据同步**
    - **属性 12: 离线数据访问完整性**
    - **验证需求: 8.3, 8.4, 8.5**

  - [x] 10.4 实现离线数据同步
    - 网络状态检测
    - 离线数据同步机制
    - _需求: 8.5_

- [ ] 11. 前端组件API集成
  - [x] 11.1 更新App.tsx主组件
    - 替换本地状态为API调用
    - 集成认证流程
    - 添加加载和错误状态处理
    - _需求: 8.1, 8.2_

  - [x] 11.2 更新NoteList组件
    - 集成笔记列表API
    - 实现分页和搜索
    - _需求: 8.1_

  - [x] 11.3 更新Editor组件
    - 集成笔记保存API
    - 实现自动保存功能
    - _需求: 8.1_

  - [x] 11.4 更新AIPanel组件
    - 集成多提供商AI对话API
    - 添加AI提供商选择器
    - 实现对话历史管理
    - 显示当前使用的模型和提供商
    - _需求: 8.1_

  - [x] 11.5 更新Settings组件
    - 添加AI提供商配置界面
    - 支持配置API密钥
    - 支持选择默认AI提供商和模型
    - 配置本地AI服务URL（Ollama、LM Studio）
    - _需求: 8.1_

- [ ] 12. 检查点 - 核心功能验证
  - 确保所有API端点正常工作
  - 验证前端与后端集成
  - 测试用户认证流程
  - 确保所有测试通过，如有问题请询问用户

- [ ] 13. Docker容器化配置
  - [ ] 13.1 创建Docker配置文件
    - 编写frontend Dockerfile
    - 编写backend Dockerfile
    - 配置Nginx反向代理
    - _需求: 10.1_

  - [ ] 13.2 配置Docker Compose
    - 创建docker-compose.yml
    - 配置服务依赖和网络
    - 设置环境变量管理（支持多AI提供商）
    - 配置本地AI服务连接（host.docker.internal）
    - _需求: 10.2_

  - [ ] 13.3 创建环境变量模板
    - 创建.env.example文件
    - 包含所有AI提供商的配置项
    - 添加配置说明文档
    - _需求: 10.3_

  - [ ]* 13.4 编写Docker部署属性测试
    - **属性 14: Docker容器环境配置有效性**
    - **验证需求: 10.3, 10.4**

  - [ ] 13.5 配置数据持久化
    - 设置PostgreSQL数据卷
    - 配置文件上传存储卷
    - _需求: 10.4_

- [ ] 14. 数据迁移工具开发
  - [ ] 14.1 创建数据迁移脚本
    - 将constants.ts中的初始数据迁移到数据库
    - 创建数据验证工具
    - _需求: 11.2, 11.3_

  - [ ]* 14.2 编写数据迁移属性测试
    - **属性 15: 数据迁移完整性保证**
    - **验证需求: 11.3, 11.4**

  - [ ] 14.3 实现备份恢复功能
    - 数据库备份脚本
    - 数据恢复验证
    - _需求: 11.4_

- [ ] 15. 性能优化和缓存策略
  - [ ] 15.1 实现API响应缓存
    - 添加Redis缓存层（可选）
    - 实现缓存失效策略
    - _需求: 8.3_

  - [ ] 15.2 优化数据库查询
    - 添加必要的数据库索引
    - 优化复杂查询性能
    - _需求: 9.5_

  - [ ] 15.3 实现API限流和监控
    - 添加请求限流中间件
    - 实现API使用监控
    - _需求: 5.5_

- [ ] 16. 实时协作功能（WebSocket）
  - [ ] 16.1 实现WebSocket服务
    - 配置Socket.io服务器
    - 实现实时消息传递
    - _需求: 7.5_

  - [ ] 16.2 集成前端实时功能
    - 添加WebSocket客户端
    - 实现实时编辑同步
    - _需求: 7.5_

- [ ] 17. 统一错误处理和日志系统
  - [ ] 17.1 实现全局错误处理
    - 创建错误处理中间件
    - 统一错误响应格式
    - _需求: 1.5_

  - [ ]* 17.2 编写错误处理属性测试
    - **属性 1: API响应格式一致性**
    - **验证需求: 1.5**

  - [ ] 17.3 配置日志系统
    - 添加Winston日志记录
    - 配置日志轮转和存储
    - _需求: 1.5_

- [ ] 18. 最终集成测试和部署准备
  - [ ] 18.1 执行完整的集成测试
    - 运行所有单元测试和属性测试
    - 执行端到端测试
    - 测试每一个功能按钮并截图判断，通过MCP 浏览器测试
    - _需求: 所有需求_

  - [ ] 18.2 性能测试和优化
    - 负载测试API性能
    - 优化数据库查询
    - _需求: 10.5_

  - [ ] 18.3 生产环境配置
    - 配置环境变量管理
    - 设置SSL证书和安全配置
    - _需求: 10.5_

- [ ] 19. 最终检查点 - 完整系统验证
  - 验证所有功能正常工作
  - 确保Docker容器正确启动
  - 验证数据迁移完成
  - 测试离线功能和数据同步
  - 确保所有测试通过，如有问题请询问用户

## 注意事项

- 标记为 `*` 的任务是可选的测试任务，可以跳过以加快MVP开发
- 每个任务都引用了具体的需求编号以确保可追溯性
- 检查点任务确保增量验证和质量控制
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边缘情况