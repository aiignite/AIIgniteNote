# 全栈后端集成需求文档

## 项目概述

为现有的AI Ignite Note前端应用添加完整的后端支持，包括数据库集成、API服务和AI功能，同时保持前端界面和用户体验不变。

## 术语表

- **Frontend**: 现有的React + TypeScript前端应用
- **Backend**: 新建的Node.js + Express API服务
- **Database**: PostgreSQL数据库，使用现有架构设计
- **API_Client**: 前端API调用封装层
- **Prisma**: TypeScript ORM，用于数据库操作
- **JWT**: JSON Web Token，用于用户认证
- **Gemini_Proxy**: 后端AI服务代理

## 需求

### 需求 1: 后端基础架构搭建

**用户故事**: 作为开发者，我需要一个完整的后端API服务，以便前端可以与数据库进行交互。

#### 验收标准

1. WHEN 启动后端服务 THEN 系统应在端口4000上运行Express服务器
2. WHEN 连接数据库 THEN 系统应成功连接到PostgreSQL数据库
3. WHEN 配置Prisma THEN 系统应生成类型安全的数据库客户端
4. WHEN 设置环境变量 THEN 系统应正确加载数据库连接和API密钥配置
5. WHEN 实现错误处理 THEN 系统应提供统一的错误响应格式

### 需求 2: 用户认证和授权系统

**用户故事**: 作为用户，我需要安全的登录和注册功能，以便保护我的笔记数据。

#### 验收标准

1. WHEN 用户注册 THEN 系统应创建新用户账户并返回JWT token
2. WHEN 用户登录 THEN 系统应验证凭据并返回有效的JWT token
3. WHEN 访问受保护的API THEN 系统应验证JWT token的有效性
4. WHEN token过期 THEN 系统应提供token刷新机制
5. WHEN 用户登出 THEN 系统应使token失效

### 需求 3: 笔记管理API

**用户故事**: 作为用户，我需要通过API管理我的笔记，以便数据能够持久化存储。

#### 验收标准

1. WHEN 创建笔记 THEN 系统应在数据库中保存笔记并返回笔记ID
2. WHEN 获取笔记列表 THEN 系统应返回用户的所有笔记（支持分页）
3. WHEN 更新笔记 THEN 系统应保存更改并创建版本历史记录
4. WHEN 删除笔记 THEN 系统应执行软删除操作
5. WHEN 搜索笔记 THEN 系统应使用全文搜索返回相关结果

### 需求 4: 文件夹和标签管理

**用户故事**: 作为用户，我需要组织我的笔记，以便更好地管理内容结构。

#### 验收标准

1. WHEN 创建文件夹 THEN 系统应支持层级文件夹结构
2. WHEN 移动笔记到文件夹 THEN 系统应更新笔记的文件夹关联
3. WHEN 创建标签 THEN 系统应允许为笔记添加多个标签
4. WHEN 按标签筛选 THEN 系统应返回包含指定标签的所有笔记
5. WHEN 删除文件夹 THEN 系统应将子笔记移动到父文件夹或根目录

### 需求 5: 多模型AI功能集成

**用户故事**: 作为用户，我需要支持多个AI模型提供商的助手功能，以便根据需求选择不同的AI服务。

#### 验收标准

1. WHEN 发送AI对话请求 THEN 系统应支持Anthropic、OpenAI、Gemini、Ollama和LM Studio等多个AI提供商
2. WHEN 选择AI模型 THEN 用户应能够在设置中配置和切换不同的AI提供商
3. WHEN 保存AI对话 THEN 系统应将对话历史和使用的模型信息存储到数据库
4. WHEN 使用AI模板 THEN 系统应支持预定义的AI提示模板，兼容所有提供商
5. WHEN 生成内容 THEN 系统应支持基于笔记内容的AI辅助功能，自动适配不同提供商的API格式
6. WHEN 管理API配额 THEN 系统应监控和限制每个AI提供商的API使用量
7. WHEN 配置本地模型 THEN 系统应支持Ollama和LM Studio的本地部署模型

### 需求 6: 文件上传和附件管理

**用户故事**: 作为用户，我需要在笔记中添加附件，以便丰富笔记内容。

#### 验收标准

1. WHEN 上传文件 THEN 系统应将文件保存到服务器并返回访问URL
2. WHEN 关联附件到笔记 THEN 系统应在数据库中记录附件关系
3. WHEN 删除附件 THEN 系统应同时删除文件和数据库记录
4. WHEN 访问附件 THEN 系统应验证用户权限后提供文件访问
5. WHEN 限制文件大小 THEN 系统应拒绝超过限制的文件上传

### 需求 7: 工作空间和协作功能

**用户故事**: 作为团队用户，我需要与他人协作编辑笔记，以便实现团队知识共享。

#### 验收标准

1. WHEN 创建工作空间 THEN 系统应允许用户创建和管理工作空间
2. WHEN 邀请成员 THEN 系统应支持通过邮件邀请用户加入工作空间
3. WHEN 设置权限 THEN 系统应支持不同的用户角色和权限级别
4. WHEN 共享笔记 THEN 系统应允许在工作空间内共享和协作编辑笔记
5. WHEN 实时同步 THEN 系统应支持多用户实时编辑同步

### 需求 8: 前端API集成和本地存储

**用户故事**: 作为开发者，我需要将前端与后端API集成，同时使用IndexedDB进行本地缓存，保持现有UI不变。

#### 验收标准

1. WHEN 替换本地状态 THEN 前端应使用API调用替代本地数据管理
2. WHEN 处理加载状态 THEN 前端应显示适当的加载和错误状态
3. WHEN 使用IndexedDB缓存 THEN 前端应将API响应数据缓存到IndexedDB中
4. WHEN 离线访问 THEN 前端应从IndexedDB读取缓存数据支持离线浏览
5. WHEN 数据同步 THEN 前端应在网络恢复时自动同步本地更改到服务器
6. WHEN 保持UI一致性 THEN 所有现有组件应保持相同的外观和行为

### 需求 9: 全文搜索功能

**用户故事**: 作为用户，我需要快速搜索我的笔记内容，以便快速找到相关信息。

#### 验收标准

1. WHEN 搜索笔记标题 THEN 系统应返回标题匹配的笔记
2. WHEN 搜索笔记内容 THEN 系统应使用PostgreSQL全文搜索功能
3. WHEN 搜索标签 THEN 系统应返回包含匹配标签的笔记
4. WHEN 高级搜索 THEN 系统应支持按文件夹、日期范围等条件筛选
5. WHEN 搜索结果排序 THEN 系统应按相关性和更新时间排序结果

### 需求 10: Docker容器化部署

**用户故事**: 作为运维人员，我需要将整个应用打包在Docker容器中，以便简化部署和环境管理。

#### 验收标准

1. WHEN 构建Docker镜像 THEN 系统应创建包含前端、后端和数据库的完整容器化解决方案
2. WHEN 使用Docker Compose THEN 系统应提供一键启动所有服务的配置文件
3. WHEN 配置环境变量 THEN 容器应支持通过环境变量配置数据库连接和API密钥
4. WHEN 数据持久化 THEN 数据库数据应通过Docker volumes持久化存储
5. WHEN 生产部署 THEN 容器应支持负载均衡和横向扩展配置

### 需求 11: 数据迁移和同步

**用户故事**: 作为开发者，我需要将现有的前端数据迁移到数据库，以便平滑过渡到新系统。

#### 验收标准

1. WHEN 初始化数据库 THEN 系统应执行SQL架构创建所有必要的表和索引
2. WHEN 迁移现有数据 THEN 系统应提供工具将前端常量数据导入数据库
3. WHEN 数据验证 THEN 系统应验证迁移数据的完整性和正确性
4. WHEN 备份恢复 THEN 系统应支持数据库备份和恢复功能
5. WHEN 版本管理 THEN 系统应支持数据库架构版本管理和升级